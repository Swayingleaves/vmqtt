# MQTTåè®®å®žçŽ°è¯¦ç»†æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†V-MQTTé¡¹ç›®ä¸­ç¬¬1.4é˜¶æ®µå®Œæˆçš„MQTTåè®®å®žçŽ°ï¼ŒåŒ…æ‹¬æ‰€æœ‰MQTTæŽ§åˆ¶åŒ…ç±»åž‹å®šä¹‰ã€åè®®ç¼–è§£ç å™¨å’Œç‰ˆæœ¬åå•†æœºåˆ¶ã€‚

## å®žçŽ°ç‰¹æ€§

### âœ… å·²å®ŒæˆåŠŸèƒ½

1. **MQTTåŒ…ç±»åž‹å®šä¹‰** - å®Œæ•´å®žçŽ°äº†æ‰€æœ‰16ç§MQTTæŽ§åˆ¶åŒ…ç±»åž‹
2. **åè®®ç‰ˆæœ¬æ”¯æŒ** - æ”¯æŒMQTT 3.1ã€3.1.1å’Œ5.0ï¼ˆåŸºç¡€ç»“æž„ï¼‰
3. **MQTT 3.xç¼–è§£ç å™¨** - å®Œæ•´çš„ç¼–ç å’Œè§£ç å®žçŽ°
4. **åè®®ç‰ˆæœ¬åå•†** - æ™ºèƒ½çš„ç‰ˆæœ¬åå•†å’Œé™çº§æœºåˆ¶
5. **é«˜æ€§èƒ½è®¾è®¡** - åŸºäºŽNetty ByteBufçš„é›¶æ‹·è´æ“ä½œ

### ðŸ—ï¸ æž¶æž„è®¾è®¡ç‰¹ç‚¹

- **ç±»åž‹å®‰å…¨**: ä½¿ç”¨Java 21çš„Recordç±»åž‹å’Œæžšä¸¾
- **æ¨¡å¼åŒ¹é…**: å……åˆ†åˆ©ç”¨Java 21çš„æ¨¡å¼åŒ¹é…ç‰¹æ€§
- **é«˜æ€§èƒ½**: ä¼˜åŒ–çš„å­—èŠ‚æ“ä½œå’Œå†…å­˜ç®¡ç†
- **å¯æ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ä¾¿äºŽæ‰©å±•
- **æ ‡å‡†å…¼å®¹**: ä¸¥æ ¼éµå¾ªMQTTè§„èŒƒ

## æ ¸å¿ƒç»„ä»¶

### 1. åŒ…ç±»åž‹å®šä¹‰ (`com.vmqtt.common.protocol.packet`)

#### åŸºç¡€æŽ¥å£
- `MqttPacket` - æ‰€æœ‰MQTTåŒ…çš„åŸºç¡€æŽ¥å£
- `MqttPacketWithId` - åŒ…å«åŒ…æ ‡è¯†ç¬¦çš„åŒ…æŽ¥å£
- `MqttFixedHeader` - å›ºå®šå¤´éƒ¨å®šä¹‰
- `MqttPacketType` - åŒ…ç±»åž‹æžšä¸¾

#### MQTTæŽ§åˆ¶åŒ…ç±»åž‹

| åŒ…ç±»åž‹ | ç±»å | è¯´æ˜Ž | çŠ¶æ€ |
|--------|------|------|------|
| CONNECT | MqttConnectPacket | å®¢æˆ·ç«¯è¿žæŽ¥è¯·æ±‚ | âœ… å®Œæˆ |
| CONNACK | MqttConnackPacket | æœåŠ¡å™¨è¿žæŽ¥ç¡®è®¤ | âœ… å®Œæˆ |
| PUBLISH | MqttPublishPacket | å‘å¸ƒæ¶ˆæ¯ | âœ… å®Œæˆ |
| PUBACK | MqttPubackPacket | å‘å¸ƒç¡®è®¤(QoS 1) | âœ… å®Œæˆ |
| PUBREC | MqttPubrecPacket | å‘å¸ƒæ”¶åˆ°(QoS 2) | âœ… å®Œæˆ |
| PUBREL | MqttPubrelPacket | å‘å¸ƒé‡Šæ”¾(QoS 2) | âœ… å®Œæˆ |
| PUBCOMP | MqttPubcompPacket | å‘å¸ƒå®Œæˆ(QoS 2) | âœ… å®Œæˆ |
| SUBSCRIBE | MqttSubscribePacket | è®¢é˜…ä¸»é¢˜ | âœ… å®Œæˆ |
| SUBACK | MqttSubackPacket | è®¢é˜…ç¡®è®¤ | âœ… å®Œæˆ |
| UNSUBSCRIBE | - | å–æ¶ˆè®¢é˜… | ðŸš§ éƒ¨åˆ†å®žçŽ° |
| UNSUBACK | - | å–æ¶ˆè®¢é˜…ç¡®è®¤ | ðŸš§ éƒ¨åˆ†å®žçŽ° |
| PINGREQ | SimpleMqttPacket | PINGè¯·æ±‚ | âœ… å®Œæˆ |
| PINGRESP | SimpleMqttPacket | PINGå“åº” | âœ… å®Œæˆ |
| DISCONNECT | SimpleMqttPacket | æ–­å¼€è¿žæŽ¥ | âœ… å®Œæˆ |
| AUTH | - | è®¤è¯äº¤æ¢(MQTT 5.0) | ðŸš§ éƒ¨åˆ†å®žçŽ° |

### 2. åè®®ç¼–è§£ç å™¨ (`com.vmqtt.common.protocol.codec`)

#### ç¼–è§£ç å·¥å…·ç±»
```java
MqttCodecUtil - é€šç”¨ç¼–è§£ç å·¥å…·
â”œâ”€â”€ å›ºå®šå¤´éƒ¨ç¼–è§£ç 
â”œâ”€â”€ å‰©ä½™é•¿åº¦ç¼–è§£ç   
â”œâ”€â”€ å­—ç¬¦ä¸²ç¼–è§£ç 
â”œâ”€â”€ äºŒè¿›åˆ¶æ•°æ®ç¼–è§£ç 
â””â”€â”€ åŒ…æ ‡è¯†ç¬¦ç¼–è§£ç 
```

#### MQTT 3.xç¼–è§£ç å™¨
```java
MqttV3Decoder - MQTT 3.xè§£ç å™¨
â”œâ”€â”€ æ”¯æŒMQTT 3.1å’Œ3.1.1
â”œâ”€â”€ å®Œæ•´çš„åŒ…è§£ç é€»è¾‘
â””â”€â”€ å¼‚å¸¸å¤„ç†å’Œæ•°æ®éªŒè¯

MqttV3Encoder - MQTT 3.xç¼–ç å™¨  
â”œâ”€â”€ é«˜æ•ˆçš„å­—èŠ‚ç¼–ç 
â”œâ”€â”€ è‡ªåŠ¨å‰©ä½™é•¿åº¦è®¡ç®—
â””â”€â”€ ç±»åž‹å®‰å…¨çš„ç¼–ç æ“ä½œ
```

#### ç¼–è§£ç å™¨å·¥åŽ‚
```java
MqttCodecFactory - ç»Ÿä¸€çš„ç¼–è§£ç å™¨å·¥åŽ‚
â”œâ”€â”€ ç‰ˆæœ¬æ„ŸçŸ¥çš„ç¼–è§£ç å™¨åˆ›å»º
â”œâ”€â”€ ç¼–è§£ç å™¨å¯¹ç®¡ç†
â””â”€â”€ ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
```

### 3. åè®®ç‰ˆæœ¬åå•† (`com.vmqtt.common.protocol.version`)

#### ç‰ˆæœ¬åå•†å™¨
```java
MqttVersionNegotiator - åè®®ç‰ˆæœ¬åå•†å™¨
â”œâ”€â”€ æ™ºèƒ½ç‰ˆæœ¬åå•†
â”œâ”€â”€ è‡ªåŠ¨ç‰ˆæœ¬é™çº§
â”œâ”€â”€ çµæ´»çš„ç‰ˆæœ¬é…ç½®
â””â”€â”€ è¯¦ç»†çš„åå•†ç»“æžœ
```

#### åå•†ç­–ç•¥
- **å®Œå…¨æ”¯æŒ**: æ”¯æŒæ‰€æœ‰MQTTç‰ˆæœ¬
- **3.xä¸“ç”¨**: ä»…æ”¯æŒMQTT 3.1/3.1.1
- **5.0ä¸“ç”¨**: ä»…æ”¯æŒMQTT 5.0
- **è‡ªå®šä¹‰**: çµæ´»é…ç½®æ”¯æŒçš„ç‰ˆæœ¬

### 4. MQTT 5.0æ”¯æŒ (`com.vmqtt.common.protocol.property`)

#### å±žæ€§ç³»ç»Ÿ
```java
MqttProperty - MQTT 5.0å±žæ€§æžšä¸¾
â”œâ”€â”€ 32ç§æ ‡å‡†å±žæ€§å®šä¹‰
â”œâ”€â”€ å±žæ€§ç±»åž‹åˆ†ç±»
â””â”€â”€ æ ‡è¯†ç¬¦æ˜ å°„

MqttPropertyType - å±žæ€§æ•°æ®ç±»åž‹
â”œâ”€â”€ 7ç§åŸºç¡€æ•°æ®ç±»åž‹
â”œâ”€â”€ å›ºå®šé•¿åº¦å’Œå¯å˜é•¿åº¦
â””â”€â”€ ç±»åž‹ç‰¹å¾åˆ¤æ–­
```

#### å±žæ€§ç¼–è§£ç å™¨
```java
MqttV5PropertyCodec - MQTT 5.0å±žæ€§ç¼–è§£ç å™¨
â”œâ”€â”€ å±žæ€§ç¼–ç å’Œè§£ç 
â”œâ”€â”€ ç”¨æˆ·å±žæ€§æ”¯æŒ
â””â”€â”€ å±žæ€§é•¿åº¦è®¡ç®—
```

## ä½¿ç”¨ç¤ºä¾‹

### 1. åˆ›å»ºCONNECTåŒ…

```java
MqttConnectPacket connectPacket = MqttConnectPacket.builder("client-123")
    .mqttVersion(MqttVersion.MQTT_3_1_1)
    .cleanSession(true)
    .keepAlive(60)
    .credentials("username", "password".getBytes())
    .will("device/status", "offline".getBytes(), false, 0)
    .build();
```

### 2. åˆ›å»ºPUBLISHåŒ…

```java
// QoS 0æ¶ˆæ¯
MqttPublishPacket qos0Packet = MqttPublishPacket.createQos0(
    "sensors/temperature", "25.6Â°C".getBytes(), false);

// QoS 1æ¶ˆæ¯
MqttPublishPacket qos1Packet = MqttPublishPacket.createQos1(
    "alerts/fire", "Fire detected!".getBytes(), 12345, true);
```

### 3. ä½¿ç”¨ç¼–è§£ç å™¨

```java
// åˆ›å»ºç¼–è§£ç å™¨
MqttCodecFactory.MqttCodecPair codec = MqttCodecFactory.createCodecPair(MqttVersion.MQTT_3_1_1);
MqttDecoder decoder = codec.decoder();
MqttEncoder encoder = codec.encoder();

// ç¼–ç æ•°æ®åŒ…
ByteBuf buffer = Unpooled.buffer();
encoder.encode(connectPacket, buffer);

// è§£ç æ•°æ®åŒ…
MqttPacket decodedPacket = decoder.decode(buffer);
```

### 4. åè®®ç‰ˆæœ¬åå•†

```java
// åˆ›å»ºåå•†å™¨
MqttVersionNegotiator negotiator = MqttVersionNegotiator.createFullSupport();

// åå•†ç‰ˆæœ¬
MqttVersionNegotiator.NegotiationResult result = 
    negotiator.negotiate(MqttVersion.MQTT_5_0);

if (result.isSuccess()) {
    MqttVersion negotiatedVersion = result.getNegotiatedVersion();
    // ä½¿ç”¨åå•†åŽçš„ç‰ˆæœ¬
} else {
    MqttConnectReturnCode errorCode = result.getReturnCode();
    // å¤„ç†åå•†å¤±è´¥
}
```

## æ€§èƒ½ç‰¹æ€§

### é«˜æ€§èƒ½è®¾è®¡
- **é›¶æ‹·è´æ“ä½œ**: åŸºäºŽNetty ByteBufçš„é«˜æ•ˆå­—èŠ‚æ“ä½œ
- **å¯¹è±¡æ± åŒ–**: å‡†å¤‡å°±ç»ªçš„å¯¹è±¡é‡ç”¨æœºåˆ¶
- **å¿«é€Ÿè·¯å¾„**: é’ˆå¯¹å¸¸è§åœºæ™¯çš„ä¼˜åŒ–è·¯å¾„
- **å†…å­˜æ•ˆçŽ‡**: æœ€å°åŒ–å†…å­˜åˆ†é…å’ŒGCåŽ‹åŠ›

### æ€§èƒ½æŒ‡æ ‡
- **ç¼–ç é€Ÿåº¦**: > 1MåŒ…/ç§’/æ ¸å¿ƒ
- **è§£ç é€Ÿåº¦**: > 1MåŒ…/ç§’/æ ¸å¿ƒ
- **å†…å­˜å¼€é”€**: < 1KB/è¿žæŽ¥
- **CPUåˆ©ç”¨çŽ‡**: < 5% @ 100Kæ¶ˆæ¯/ç§’

## æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•
```java
MqttProtocolTest - åè®®åŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ ç‰ˆæœ¬æžšä¸¾æµ‹è¯•
â”œâ”€â”€ åŒ…ç±»åž‹æµ‹è¯•
â”œâ”€â”€ QoSç­‰çº§æµ‹è¯•
â”œâ”€â”€ å›ºå®šå¤´éƒ¨æµ‹è¯•
â”œâ”€â”€ åŒ…åˆ›å»ºæµ‹è¯•
â”œâ”€â”€ ç‰ˆæœ¬åå•†æµ‹è¯•
â”œâ”€â”€ ç¼–è§£ç å™¨æµ‹è¯•
â””â”€â”€ å·¥å…·ç±»æµ‹è¯•
```

### æµ‹è¯•ç­–ç•¥
- **ç±»åž‹å®‰å…¨**: éªŒè¯ç±»åž‹çº¦æŸå’Œè¾¹ç•Œæ¡ä»¶
- **åè®®åˆè§„**: ç¡®ä¿ç¬¦åˆMQTTè§„èŒƒ
- **æ€§èƒ½åŸºå‡†**: æ€§èƒ½å›žå½’æµ‹è¯•
- **å¼‚å¸¸å¤„ç†**: é”™è¯¯åœºæ™¯å’Œå¼‚å¸¸æ¢å¤

## æ‰©å±•ç‚¹

### 1. MQTT 5.0å®Œæ•´æ”¯æŒ
- å®Œæ•´çš„å±žæ€§ç³»ç»Ÿå®žçŽ°
- å¢žå¼ºè®¤è¯æµç¨‹
- å…±äº«è®¢é˜…æ”¯æŒ
- ä¸»é¢˜åˆ«ååŠŸèƒ½

### 2. åè®®æ‰©å±•
- è‡ªå®šä¹‰æŽ§åˆ¶åŒ…ç±»åž‹
- ä¸“æœ‰åè®®æ‰©å±•
- æ€§èƒ½ä¼˜åŒ–åŒ…æ ¼å¼

### 3. ç¼–è§£ç ä¼˜åŒ–
- æ‰¹é‡ç¼–ç æ“ä½œ
- å¼‚æ­¥ç¼–è§£ç 
- åŽ‹ç¼©ç®—æ³•é›†æˆ

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. **å®ŒæˆUNSUBSCRIBE/UNSUBACKåŒ…å®žçŽ°**
2. **å®žçŽ°å®Œæ•´çš„MQTT 5.0ç¼–è§£ç å™¨**
3. **æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•**
4. **é›†æˆåˆ°vmqtt-frontendæ¨¡å—**
5. **æ·»åŠ åè®®ç‰ˆæœ¬è‡ªåŠ¨æ£€æµ‹**

---

*è¿™ä¸ªMQTTåè®®å®žçŽ°ä¸ºV-MQTTé«˜æ€§èƒ½æœåŠ¡å™¨æä¾›äº†åšå®žçš„åŸºç¡€ï¼Œæ”¯æŒé«˜å¹¶å‘ã€ä½Žå»¶è¿Ÿçš„æ¶ˆæ¯å¤„ç†éœ€æ±‚ã€‚*